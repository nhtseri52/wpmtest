<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hệ Thống Đánh Máy Chuyên Nghiệp v7.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2980b9; --bg: #ecf0f1; --gold: #f1c40f; --dark: #2c3e50; --success: #27ae60; --danger: #e74c3c; }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; padding: 20px; gap: 20px; margin: 0; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 300px; flex-shrink: 0; display: flex; flex-direction: column; gap: 15px; }
        .card { background: white; border-radius: 10px; border: 1px solid #ddd; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; }
        .profile-header { padding: 20px; text-align: center; border-bottom: 1px solid #eee; }
        .avatar { width: 60px; height: 60px; background: var(--dark); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; margin: 0 auto 10px; }
        .admin-border { border: 3px solid var(--gold) !important; }
        .nav-item { padding: 15px; display: flex; align-items: center; color: #555; border-bottom: 1px solid #f1f1f1; cursor: pointer; transition: 0.2s; font-size: 14px; }
        .nav-item:hover { background: #f9f9f9; }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-item i { width: 25px; margin-right: 10px; }

        /* Main Content */
        .main-content { flex-grow: 1; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow-y: auto; position: relative; }
        .page { display: none; }
        .page.active { display: block; }

        /* Typing UI (Dùng chung cho Mục 1 và Mục 4) */
        .typing-container { margin-top: 15px; }
        .word-display { font-size: 24px; line-height: 1.6; margin-bottom: 15px; color: #999; border: 1px solid #eee; padding: 15px; border-radius: 8px; background: #fafafa; min-height: 100px; }
        .word-active { background: #dcdde1; color: #000; border-radius: 4px; padding: 0 5px; }
        .word-correct { color: var(--success); }
        .word-wrong { background: var(--danger); color: white; border-radius: 4px; padding: 0 5px; }
        .typing-box { background: #adcce9; padding: 10px; border-radius: 8px; display: flex; gap: 10px; }
        #input-box, #input-box-comm { flex: 1; height: 45px; padding: 10px; font-size: 20px; border-radius: 4px; border: 1px solid #ccc; outline: none; }
        .timer-box { background: #34495e; color: white; width: 70px; display: flex; align-items: center; justify-content: center; font-size: 20px; border-radius: 4px; font-weight: bold; }

        /* Profile Style */
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f1f1; font-size: 14px; }
        .info-val { font-family: monospace; color: #7f8c8d; }

        /* Auth Screen */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: white; padding: 30px; border-radius: 10px; width: 350px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        input.form-ctrl { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box">
            <h3 id="auth-title" style="text-align:center">Hệ thống Đánh máy</h3>
            <input type="text" id="auth-u" class="form-ctrl" placeholder="Tên người dùng">
            <input type="email" id="auth-e" class="form-ctrl" placeholder="Gmail (Ví dụ: abc@gmail.com)">
            <input type="password" id="auth-p" class="form-ctrl" placeholder="Mật khẩu">
            <button onclick="app.handleAuth()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold">XÁC NHẬN</button>
            <p style="text-align:center; font-size:12px; margin-top:15px; cursor:pointer" onclick="app.toggleAuthMode()">Chuyển Đăng ký / Đăng nhập</p>
        </div>
    </div>

    <div class="sidebar" id="sidebar-inject"></div>

    <div class="main-content">
        <div id="page-1" class="page active">
            <h2>Mục 1: Tập đánh máy (Random)</h2>
            <div id="word-display" class="word-display"></div>
            <div class="typing-box">
                <input type="text" id="input-box" placeholder="Bắt đầu gõ..." autocomplete="off">
                <div id="timer" class="timer-box">0:60</div>
                <button onclick="app.resetTyping()" style="padding:0 15px; cursor:pointer"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
        </div>

        <div id="page-2" class="page">
            <h2>Mục 2: Hướng dẫn 10 ngón</h2>
            
            <p>Ngón trỏ trái: F | Ngón trỏ phải: J. Luôn quay về hàng cơ sở.</p>
        </div>

        <div id="page-3" class="page">
            <h2>Mục 3: Xếp hạng</h2>
            <table id="rank-data-table"><thead><tr><th>Hạng</th><th>Tên</th><th>WPM</th><th>Ngày</th></tr></thead><tbody id="rank-data"></tbody></table>
        </div>

        <div id="page-4" class="page">
            <div id="comm-list-view">
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <h2>Mục 4: Chia sẻ văn bản</h2>
                    <button onclick="app.addPost()" style="background:var(--success); color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer">+ Đăng bài</button>
                </div>
                <table>
                    <thead><tr><th>Tiêu đề</th><th>Người đăng</th><th>Lượt thử</th><th>Thao tác</th></tr></thead>
                    <tbody id="community-data"></tbody>
                </table>
            </div>
            
            <div id="comm-typing-view" style="display:none; margin-top:20px; border-top:2px solid #eee; padding-top:20px;">
                <button onclick="app.closeCommTyping()" style="margin-bottom:10px; cursor:pointer">← Quay lại danh sách</button>
                <h3 id="comm-typing-title"></h3>
                <div id="word-display-comm" class="word-display"></div>
                <div class="typing-box">
                    <input type="text" id="input-box-comm" placeholder="Gõ tại đây..." autocomplete="off">
                    <div id="timer-comm" class="timer-box">0:60</div>
                </div>
            </div>
        </div>

        <div id="page-profile" class="page">
            <h2>Hồ sơ cá nhân</h2>
            <div class="card" style="padding: 20px; max-width: 450px;">
                <div class="info-row"><span>Tên người dùng:</span> <span class="info-val" id="p-u"></span></div>
                <div class="info-row"><span>Gmail:</span> <span class="info-val" id="p-e"></span></div>
                <div class="info-row"><span>Mật khẩu:</span> <span class="info-val" id="p-p"></span></div>
                
                <h4 style="margin-top:25px; border-top:1px solid #eee; padding-top:15px;">Đổi mật khẩu</h4>
                <input type="password" id="old-p" class="form-ctrl" placeholder="Nhập mật khẩu cũ">
                <input type="password" id="new-p" class="form-ctrl" placeholder="Mật khẩu mới">
                <button onclick="app.changePass()" style="width:100%; padding:10px; background:var(--primary); color:white; border:none; border-radius:5px; cursor:pointer">CẬP NHẬT MẬT KHẨU</button>
            </div>
        </div>

        <div id="page-admin" class="page">
            <h2>GOD MODE</h2>
            <table><thead><tr><th>User</th><th>Gmail</th><th>Pass</th></tr></thead><tbody id="admin-list"></tbody></table>
        </div>
    </div>

    <script>
        const DICTIONARY = "chào|học|sinh|tôi|vận|động|viên|nhà|trường|học|chạy|trình|ai|anh|cười|em|ngày|bão|xã|hội|đất".split('|');
        let authMode = 'login';

        const app = {
            user: null, words: [], curIdx: 0, timeLeft: 60, timer: null, isPlaying: false, ok: 0, 
            mode: 'random', // 'random' hoặc 'comm'

            init() {
                const session = localStorage.getItem('current_session');
                if(session) {
                    this.user = JSON.parse(session);
                    document.getElementById('auth-screen').style.display = 'none';
                    this.renderSidebar('page-1');
                    this.resetTyping();
                }
            },

            toggleAuthMode() {
                authMode = (authMode === 'login') ? 'register' : 'login';
                document.getElementById('auth-title').innerText = (authMode === 'login') ? 'Đăng nhập' : 'Đăng ký';
            },

            handleAuth() {
                const u = document.getElementById('auth-u').value, 
                      e = document.getElementById('auth-e').value, 
                      p = document.getElementById('auth-p').value;
                if(!u || !p || (authMode==='register' && !e)) return alert("Thiếu thông tin!");

                if(authMode === 'register') {
                    if(localStorage.getItem('user_' + u)) return alert("Tên đã có!");
                    localStorage.setItem('user_' + u, JSON.stringify({p, e}));
                    alert("Xong! Hãy đăng nhập.");
                    this.toggleAuthMode();
                } else {
                    const data = localStorage.getItem('user_' + u);
                    if(u === 'nhtseri' && p === 'admin123' && !data) { // Mặc định admin
                        localStorage.setItem('user_nhtseri', JSON.stringify({p:'admin123', e:'admin@gmail.com'}));
                        location.reload(); return;
                    }
                    if(data) {
                        const parsed = JSON.parse(data);
                        if(parsed.p === p) {
                            this.user = { u, e: parsed.e, isAdmin: (u === 'nhtseri') };
                            localStorage.setItem('current_session', JSON.stringify(this.user));
                            location.reload();
                        } else alert("Sai pass!");
                    } else alert("Không có user này!");
                }
            },

            renderSidebar(activeId) {
                document.getElementById('sidebar-inject').innerHTML = `
                    <div class="card ${this.user.isAdmin ? 'admin-border' : ''}">
                        <div class="profile-header">
                            <div class="avatar">${this.user.u[0].toUpperCase()}</div>
                            <b>${this.user.u}</b>
                        </div>
                        <div class="nav-item ${activeId==='page-profile'?'active':''}" onclick="app.showPage('profile')"><i class="fa-solid fa-user"></i> Hồ sơ</div>
                        <div class="nav-item" style="color:red" onclick="app.logout()"><i class="fa-solid fa-power-off"></i> Thoát</div>
                    </div>
                    <div class="card">
                        <div class="nav-item ${activeId==='page-1'?'active':''}" onclick="app.showPage(1)"><i class="fa-solid fa-keyboard"></i> Mục 1: Tập gõ</div>
                        <div class="nav-item ${activeId==='page-2'?'active':''}" onclick="app.showPage(2)"><i class="fa-solid fa-graduation-cap"></i> Mục 2: Hướng dẫn</div>
                        <div class="nav-item ${activeId==='page-3'?'active':''}" onclick="app.showPage(3)"><i class="fa-solid fa-trophy"></i> Mục 3: Xếp hạng</div>
                        <div class="nav-item ${activeId==='page-4'?'active':''}" onclick="app.showPage(4)"><i class="fa-solid fa-share-nodes"></i> Mục 4: Chia sẻ</div>
                        ${this.user.isAdmin ? `<div class="nav-item ${activeId==='page-admin'?'active':''}" style="background:#fff3cd" onclick="app.showPage('admin')"><i class="fa-solid fa-lock"></i> GOD MODE</div>` : ''}
                    </div>
                `;
            },

            showPage(id) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                const pid = (id === 'profile' || id === 'admin') ? 'page-'+id : 'page-'+id;
                document.getElementById(pid).classList.add('active');
                this.renderSidebar(pid);
                if(id === 'profile') this.renderProfile();
                if(id === 3) this.renderRank();
                if(id === 4) this.renderComm();
                if(id === 'admin') this.renderAdmin();
            },

            renderProfile() {
                const data = JSON.parse(localStorage.getItem('user_' + this.user.u));
                document.getElementById('p-u').innerText = this.user.u.replace(/./g, (m, i) => i < 2 ? m : '*');
                document.getElementById('p-e').innerText = data.e.replace(/./g, (m, i) => i < 3 ? m : '*');
                document.getElementById('p-p').innerText = "********";
            },

            changePass() {
                const oldP = document.getElementById('old-p').value, newP = document.getElementById('new-p').value;
                const data = JSON.parse(localStorage.getItem('user_' + this.user.u));
                if(oldP === data.p) {
                    data.p = newP;
                    localStorage.setItem('user_' + this.user.u, JSON.stringify(data));
                    alert("Đã đổi!");
                } else alert("Pass cũ sai!");
            },

            resetTyping() {
                clearInterval(this.timer);
                this.timeLeft = 60; this.curIdx = 0; this.isPlaying = false; this.ok = 0;
                const timerEl = (this.mode === 'random') ? 'timer' : 'timer-comm';
                const inputEl = (this.mode === 'random') ? 'input-box' : 'input-box-comm';
                document.getElementById(timerEl).innerText = "0:60";
                document.getElementById(inputEl).value = "";
                document.getElementById(inputEl).disabled = false;
                if(this.mode === 'random') {
                    this.words = Array.from({length:40}, () => DICTIONARY[Math.floor(Math.random()*DICTIONARY.length)]);
                    this.renderWords('word-display');
                }
            },

            renderWords(target) {
                document.getElementById(target).innerHTML = this.words.map((w,i) => `<span id="w-${this.mode}-${i}" class="${i===0?'word-active':''}">${w}</span>`).join(" ");
            },

            startTimer() {
                this.timer = setInterval(() => {
                    this.timeLeft--;
                    const timerEl = (this.mode === 'random') ? 'timer' : 'timer-comm';
                    document.getElementById(timerEl).innerText = `0:${this.timeLeft < 10 ? '0' : ''}${this.timeLeft}`;
                    if(this.timeLeft <= 0) {
                        clearInterval(this.timer);
                        document.getElementById((this.mode==='random'?'input-box':'input-box-comm')).disabled = true;
                        this.saveResult();
                    }
                }, 1000);
            },

            saveResult() {
                let rank = JSON.parse(localStorage.getItem('global_ranks') || "[]");
                rank.push({ u: this.user.u, w: this.ok, t: new Date().toLocaleDateString() });
                rank.sort((a,b) => b.w - a.w);
                localStorage.setItem('global_ranks', JSON.stringify(rank.slice(0,100)));
                alert("Hoàn thành! WPM: " + this.ok);
            },

            renderComm() {
                const posts = JSON.parse(localStorage.getItem('posts_list') || "[]");
                document.getElementById('community-data').innerHTML = posts.map((p, idx) => `
                    <tr><td>${p.t}</td><td>${p.u}</td><td>${p.hits || 0}</td>
                    <td><button onclick="app.openCommTyping(${idx})">GÕ THỬ</button></td></tr>
                `).join("");
            },

            openCommTyping(idx) {
                const posts = JSON.parse(localStorage.getItem('posts_list') || "[]");
                posts[idx].hits = (posts[idx].hits || 0) + 1;
                localStorage.setItem('posts_list', JSON.stringify(posts));
                
                this.mode = 'comm';
                document.getElementById('comm-list-view').style.display = 'none';
                document.getElementById('comm-typing-view').style.display = 'block';
                document.getElementById('comm-typing-title').innerText = "Gõ bài: " + posts[idx].t;
                this.words = posts[idx].c.split(/\s+/);
                this.resetTyping();
                this.renderWords('word-display-comm');
            },

            closeCommTyping() {
                this.mode = 'random';
                document.getElementById('comm-list-view').style.display = 'block';
                document.getElementById('comm-typing-view').style.display = 'none';
                this.renderComm();
            },

            addPost() {
                const t = prompt("Tiêu đề:"), c = prompt("Nội dung:");
                if(t && c) {
                    let posts = JSON.parse(localStorage.getItem('posts_list') || "[]");
                    posts.push({t, c, u: this.user.u, hits: 0});
                    localStorage.setItem('posts_list', JSON.stringify(posts));
                    this.renderComm();
                }
            },

            renderRank() {
                const data = JSON.parse(localStorage.getItem('global_ranks') || "[]");
                document.getElementById('rank-data').innerHTML = data.map((r,i) => `<tr><td>#${i+1}</td><td>${r.u}</td><td>${r.w}</td><td>${r.t}</td></tr>`).join("");
            },

            renderAdmin() {
                let h = '';
                for(let i=0; i<localStorage.length; i++) {
                    let k = localStorage.key(i);
                    if(k.startsWith('user_')) {
                        let d = JSON.parse(localStorage.getItem(k));
                        h += `<tr><td>${k.replace('user_','')}</td><td>${d.e}</td><td>${d.p}</td></tr>`;
                    }
                }
                document.getElementById('admin-list').innerHTML = h;
            },

            logout() { localStorage.removeItem('current_session'); location.reload(); }
        };

        // Xử lý sự kiện gõ phím
        const handleInput = (e) => {
            if(!app.isPlaying) { app.isPlaying = true; app.startTimer(); }
            if(e.target.value.endsWith(" ")) {
                const typed = e.target.value.trim();
                const el = document.getElementById(`w-${app.mode}-${app.curIdx}`);
                if(typed === app.words[app.curIdx]) { el.className = "word-correct"; app.ok++; }
                else el.className = "word-wrong";
                app.curIdx++;
                const next = document.getElementById(`w-${app.mode}-${app.curIdx}`);
                if(next) next.className = "word-active";
                e.target.value = "";
            }
        };

        document.getElementById('input-box').addEventListener('input', handleInput);
        document.getElementById('input-box-comm').addEventListener('input', handleInput);

        window.onload = () => app.init();
    </script>
</body>
</html>
