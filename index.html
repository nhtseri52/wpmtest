<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hệ Thống Đánh Máy Chuyên Nghiệp</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2980b9; --bg: #f0f2f5; --gold: #f1c40f; --dark: #2c3e50; --success: #27ae60; --danger: #e74c3c; --white: #ffffff; }
        * { box-sizing: border-box; transition: 0.2s; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; padding: 20px; gap: 20px; margin: 0; height: 100vh; overflow: hidden; }

        /* Sidebar & Layout */
        .sidebar { width: 280px; flex-shrink: 0; display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--white); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden; border: 1px solid #e0e0e0; }
        .main-content { flex-grow: 1; background: var(--white); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow-y: auto; position: relative; }

        /* Navigation */
        .profile-header { padding: 20px; text-align: center; border-bottom: 1px solid #eee; }
        .avatar { width: 55px; height: 55px; background: var(--dark); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; margin: 0 auto 10px; border: 2px solid var(--gold); }
        .nav-item { padding: 12px 20px; display: flex; align-items: center; color: #555; cursor: pointer; border-bottom: 1px solid #f9f9f9; }
        .nav-item:hover { background: #f1f1f1; }
        .nav-item.active { background: var(--primary); color: white; }

        /* Typing Area */
        .word-display { font-size: 24px; line-height: 1.6; margin-bottom: 20px; border: 2px solid #eee; padding: 20px; border-radius: 10px; background: #fafafa; min-height: 120px; color: #999; }
        .word-active { background: #dcdde1; color: #000; border-radius: 4px; padding: 0 5px; border-bottom: 2px solid var(--primary); }
        .word-correct { color: var(--success); }
        .word-wrong { background: var(--danger); color: white; border-radius: 4px; padding: 0 5px; }
        .typing-box { background: #adcce9; padding: 15px; border-radius: 10px; display: flex; gap: 15px; }
        .input-style { flex: 1; height: 50px; padding: 10px 15px; border: none; border-radius: 6px; font-size: 20px; outline: none; }
        .timer-box { background: var(--dark); color: white; width: 80px; display: flex; align-items: center; justify-content: center; font-size: 22px; border-radius: 6px; font-weight: bold; }

        /* Modals - Bảng thông báo riêng */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-box { background: white; padding: 30px; border-radius: 15px; width: 380px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-icon { font-size: 50px; margin-bottom: 15px; }
        .btn-modal { margin-top: 20px; padding: 10px 25px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: var(--primary); color: white; }

        /* Auth Screen */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 9998; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: white; padding: 40px; border-radius: 15px; width: 360px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .auth-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; }

        .page { display: none; } .page.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
    </style>
</head>
<body>

    <div id="modal-msg" class="modal-overlay">
        <div class="modal-box">
            <div id="m-icon" class="modal-icon"></div>
            <h3 id="m-title">Thông báo</h3>
            <p id="m-body"></p>
            <button class="btn-modal" onclick="app.closeModal()">ĐÓNG</button>
        </div>
    </div>

    <div id="modal-result" class="modal-overlay">
        <div class="modal-box" style="width: 450px;">
            <div class="modal-icon" style="color: var(--gold)"><i class="fa-solid fa-trophy"></i></div>
            <h3>KẾT QUẢ CỦA BẠN</h3>
            <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                <div><div style="font-size: 30px; font-weight: bold;" id="res-wpm">0</div><small>WPM (Tốc độ)</small></div>
                <div><div style="font-size: 30px; font-weight: bold;" id="res-acc">0%</div><small>Accuracy (Độ chính xác)</small></div>
            </div>
            <button class="btn-modal" onclick="app.closeResult()">TIẾP TỤC</button>
        </div>
    </div>

    <div id="auth-screen">
        <div class="auth-card">
            <h2 id="auth-title" style="text-align: center; margin-bottom: 20px;">Đăng nhập</h2>
            <div id="reg-fields" style="display: none;"><input type="email" id="auth-e" placeholder="Nhập Gmail"></div>
            <input type="text" id="auth-u" placeholder="Tên đăng nhập">
            <input type="password" id="auth-p" placeholder="Mật khẩu">
            <button class="btn-modal" style="width: 100%;" onclick="app.handleAuth()">XÁC NHẬN</button>
            <p style="text-align: center; font-size: 13px; margin-top: 15px; color: var(--primary); cursor: pointer;" onclick="app.toggleAuth()">Chuyển sang Đăng ký / Đăng nhập</p>
        </div>
    </div>

    <div class="sidebar" id="sidebar-inject"></div>

    <div class="main-content">
        <div id="page-1" class="page active">
            <h2>Luyện gõ phím</h2>
            <div id="word-display-1" class="word-display"></div>
            <div class="typing-box">
                <input type="text" id="input-1" class="input-style" placeholder="Bắt đầu gõ phím tại đây..." autocomplete="off">
                <div id="timer-1" class="timer-box">60</div>
            </div>
        </div>

        <div id="page-4" class="page">
            <div id="comm-list-view">
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <h2>Cộng đồng chia sẻ</h2>
                    <button class="btn-modal" style="margin:0" onclick="app.addPost()">+ Đăng bài</button>
                </div>
                <table><thead><tr><th>Tiêu đề</th><th>Người đăng</th><th>Thao tác</th></tr></thead><tbody id="comm-list"></tbody></table>
            </div>
            <div id="comm-typing-view" style="display:none">
                <button onclick="app.closeComm()" style="margin-bottom:15px; cursor:pointer">← Quay lại</button>
                <h3 id="comm-title-display"></h3>
                <div id="word-display-comm" class="word-display"></div>
                <div class="typing-box">
                    <input type="text" id="input-comm" class="input-style" autocomplete="off">
                    <div id="timer-comm" class="timer-box">60</div>
                </div>
            </div>
        </div>

        <div id="page-profile" class="page">
            <h2>Hồ sơ cá nhân</h2>
            <div class="card" style="padding: 25px; max-width: 450px;">
                <p>Tên người dùng: <b id="prof-u"></b></p>
                <p>Gmail liên kết: <b id="prof-e"></b></p>
                <hr>
                <input type="password" id="new-p" class="input-style" style="border: 1px solid #ddd; margin-bottom: 10px; width:100%" placeholder="Mật khẩu mới">
                <button class="btn-modal" style="width: 100%;" onclick="app.updatePass()">ĐỔI MẬT KHẨU</button>
            </div>
        </div>

        <div id="page-admin" class="page">
            <h2>QUẢN TRỊ VIÊN (GOD MODE)</h2>
            <table><thead><tr><th>User</th><th>Pass</th><th>Gmail</th></tr></thead><tbody id="admin-list"></tbody></table>
        </div>
    </div>

    <script>
        const DICT = "tôi|đi|học|mỗi|ngày|bàn|phím|máy|tính|nhanh|thành|công|chính|xác|tốc|độ|luyện|tập".split('|');
        let authMode = 'login';

        const app = {
            user: null, words: [], curIdx: 0, timeLeft: 60, timer: null, isPlaying: false, ok: 0, errors: 0, mode: '1',

            init() {
                const session = localStorage.getItem('current_session');
                if(session) {
                    this.user = JSON.parse(session);
                    document.getElementById('auth-screen').style.display = 'none';
                    this.renderSidebar('page-1');
                    this.resetTyping();
                }
            },

            showModal(title, body, type) {
                const icon = document.getElementById('m-icon');
                if(type === 'success') { icon.innerHTML = '<i class="fa-solid fa-circle-check"></i>'; icon.style.color = 'var(--success)'; }
                else { icon.innerHTML = '<i class="fa-solid fa-circle-xmark"></i>'; icon.style.color = 'var(--danger)'; }
                document.getElementById('m-title').innerText = title;
                document.getElementById('m-body').innerText = body;
                document.getElementById('modal-msg').style.display = 'flex';
            },

            closeModal() { document.getElementById('modal-msg').style.display = 'none'; },

            toggleAuth() {
                authMode = (authMode === 'login') ? 'register' : 'login';
                document.getElementById('auth-title').innerText = (authMode === 'login') ? 'Đăng nhập' : 'Đăng ký';
                document.getElementById('reg-fields').style.display = (authMode === 'login') ? 'none' : 'block';
            },

            handleAuth() {
                const u = document.getElementById('auth-u').value.trim(), p = document.getElementById('auth-p').value.trim(), e = document.getElementById('auth-e').value.trim();
                if(!u || !p) return this.showModal("Lỗi", "Vui lòng nhập đầy đủ thông tin!", "error");

                if(authMode === 'register') {
                    if(localStorage.getItem('user_'+u)) return this.showModal("Lỗi", "Tài khoản này đã tồn tại!", "error");
                    localStorage.setItem('user_'+u, JSON.stringify({p, e: e || 'user@gmail.com'}));
                    this.showModal("Thành công", "Đã đăng ký tài khoản thành công!", "success");
                    this.toggleAuth();
                } else {
                    if(u === 'nhtseri' && p === 'admin123') { // Hardfix Admin
                        if(!localStorage.getItem('user_nhtseri')) localStorage.setItem('user_nhtseri', JSON.stringify({p:'admin123', e:'admin@gmail.com'}));
                    }
                    const data = localStorage.getItem('user_'+u);
                    if(data) {
                        const d = JSON.parse(data);
                        if(d.p === p) {
                            this.user = {u, e: d.e, isAdmin: (u === 'nhtseri')};
                            localStorage.setItem('current_session', JSON.stringify(this.user));
                            // Thông báo thành công trước khi load lại
                            this.showModal("Thành công", "Đăng nhập thành công! Đang vào hệ thống...", "success");
                            setTimeout(() => location.reload(), 1000);
                        } else this.showModal("Thất bại", "Sai mật khẩu, vui lòng kiểm tra lại!", "error");
                    } else this.showModal("Thất bại", "Tài khoản không tồn tại trên hệ thống!", "error");
                }
            },

            renderSidebar(activeId) {
                document.getElementById('sidebar-inject').innerHTML = `
                    <div class="card">
                        <div class="profile-header">
                            <div class="avatar">${this.user.u[0].toUpperCase()}</div>
                            <b>${this.user.u}</b>
                        </div>
                        <div class="nav-item ${activeId==='page-profile'?'active':''}" onclick="app.showPage('profile')">Hồ sơ</div>
                        <div class="nav-item ${activeId==='page-1'?'active':''}" onclick="app.showPage(1)">Tập gõ</div>
                        <div class="nav-item ${activeId==='page-4'?'active':''}" onclick="app.showPage(4)">Cộng đồng</div>
                        ${this.user.isAdmin ? `<div class="nav-item ${activeId==='page-admin'?'active':''}" style="color:var(--gold)" onclick="app.showPage('admin')">GOD MODE</div>` : ''}
                        <div class="nav-item" style="color:var(--danger)" onclick="app.logout()">Đăng xuất</div>
                    </div>
                `;
            },

            showPage(id) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                const pid = 'page-'+id;
                document.getElementById(pid).classList.add('active');
                this.renderSidebar(pid);
                if(id === 'profile') {
                    document.getElementById('prof-u').innerText = this.user.u;
                    document.getElementById('prof-e').innerText = this.user.e.replace(/.(?=.{4})/g, '*');
                }
                if(id === 4) this.renderComm();
                if(id === 'admin') this.renderAdmin();
            },

            resetTyping() {
                clearInterval(this.timer); this.timeLeft = 60; this.curIdx = 0; this.isPlaying = false; this.ok = 0; this.errors = 0;
                const suf = (this.mode === '1') ? '1' : 'comm';
                document.getElementById('timer-'+suf).innerText = "60";
                document.getElementById('input-'+suf).value = "";
                document.getElementById('input-'+suf).disabled = false;
                if(this.mode === '1') {
                    this.words = Array.from({length:40}, () => DICT[Math.floor(Math.random()*DICT.length)]);
                    this.renderWords('word-display-1');
                }
            },

            renderWords(target) {
                document.getElementById(target).innerHTML = this.words.map((w,i) => `<span id="w-${this.mode}-${i}" class="${i===0?'word-active':''}">${w}</span>`).join(" ");
            },

            startTimer() {
                this.timer = setInterval(() => {
                    this.timeLeft--;
                    const suf = (this.mode === '1') ? '1' : 'comm';
                    document.getElementById('timer-'+suf).innerText = this.timeLeft;
                    if(this.timeLeft <= 0) this.finishTyping();
                }, 1000);
            },

            finishTyping() {
                clearInterval(this.timer);
                const total = this.ok + this.errors;
                const accuracy = total > 0 ? Math.round((this.ok / total) * 100) : 0;
                document.getElementById('res-wpm').innerText = this.ok;
                document.getElementById('res-acc').innerText = accuracy + "%";
                document.getElementById('modal-result').style.display = 'flex';
                const suf = (this.mode === '1') ? '1' : 'comm';
                document.getElementById('input-'+suf).disabled = true;
            },

            closeResult() { document.getElementById('modal-result').style.display = 'none'; this.resetTyping(); },

            renderComm() {
                const posts = JSON.parse(localStorage.getItem('posts_list') || "[]");
                document.getElementById('comm-list').innerHTML = posts.map((p, idx) => `<tr><td><b>${p.t}</b></td><td>${p.u}</td><td><button class="btn-modal" style="padding:5px 10px; margin:0" onclick="app.openComm(${idx})">GÕ THỬ</button></td></tr>`).join("");
            },

            openComm(idx) {
                const p = JSON.parse(localStorage.getItem('posts_list'))[idx];
                this.mode = 'comm';
                document.getElementById('comm-list-view').style.display = 'none';
                document.getElementById('comm-typing-view').style.display = 'block';
                document.getElementById('comm-title-display').innerText = "Đang gõ: " + p.t;
                this.words = p.c.split(/\s+/);
                this.resetTyping(); this.renderWords('word-display-comm');
            },

            closeComm() { this.mode = '1'; document.getElementById('comm-list-view').style.display = 'block'; document.getElementById('comm-typing-view').style.display = 'none'; this.renderComm(); },

            addPost() {
                const t = prompt("Tiêu đề bài gõ:"), c = prompt("Nội dung gõ:");
                if(t && c) {
                    let posts = JSON.parse(localStorage.getItem('posts_list') || "[]");
                    posts.push({t, c, u: this.user.u});
                    localStorage.setItem('posts_list', JSON.stringify(posts));
                    this.renderComm();
                }
            },

            renderAdmin() {
                let h = '';
                for(let i=0; i<localStorage.length; i++){
                    let k = localStorage.key(i);
                    if(k.startsWith('user_')){
                        let d = JSON.parse(localStorage.getItem(k));
                        h += `<tr><td>${k.replace('user_','')}</td><td>${d.p}</td><td>${d.e}</td></tr>`;
                    }
                }
                document.getElementById('admin-list').innerHTML = h;
            },

            logout() { localStorage.removeItem('current_session'); location.reload(); }
        };

        const handleInput = (e) => {
            if(!app.isPlaying) { app.isPlaying = true; app.startTimer(); }
            if(e.target.value.endsWith(" ")) {
                const typed = e.target.value.trim();
                const el = document.getElementById(`w-${app.mode}-${app.curIdx}`);
                if(typed === app.words[app.curIdx]) { el.className = "word-correct"; app.ok++; }
                else { el.className = "word-wrong"; app.errors++; }
                app.curIdx++;
                const next = document.getElementById(`w-${app.mode}-${app.curIdx}`);
                if(next) next.className = "word-active";
                e.target.value = "";
                if(app.curIdx >= app.words.length) app.finishTyping();
            }
        };

        document.getElementById('input-1').addEventListener('input', handleInput);
        document.getElementById('input-comm').addEventListener('input', handleInput);
        window.onload = () => app.init();
    </script>
</body>
</html>
