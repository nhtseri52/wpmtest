<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Master - Community & God Mode</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #4a90e2; --bg: #f4f7f9; --text: #333; --success: #5cb85c; --error: #d9534f; --admin-gold: #f39c12; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        .main-container { display: flex; gap: 20px; max-width: 1450px; margin: auto; }

        /* Sidebar */
        .sidebar { width: 300px; flex-shrink: 0; }
        .menu-card { background: white; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 15px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .menu-item { padding: 13px 15px; display: flex; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; font-size: 14px; }
        .menu-item:hover { background: #f8f9fa; }
        .menu-item.active { background: var(--primary); color: white; border-bottom: none; }
        .menu-item i { width: 25px; margin-right: 10px; }

        .admin-frame { border: 2px solid var(--admin-gold) !important; background: #fffdf5 !important; }
        .admin-badge { background: var(--admin-gold); color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: auto; }

        /* Content */
        .content { flex-grow: 1; background: white; padding: 30px; border-radius: 8px; border: 1px solid #ddd; min-height: 800px; }
        
        /* Typing Engine */
        .word-wrapper { background: #fff; border: 1px solid #ccc; border-radius: 6px; padding: 20px; font-size: 24px; line-height: 1.6; height: 120px; overflow: hidden; position: relative; margin-bottom: 20px; }
        #word-display { display: flex; flex-wrap: wrap; gap: 10px; transition: 0.2s; }
        .word { padding: 2px 5px; color: #888; border-radius: 4px; }
        .word.current { background: #eee; color: #000; }
        .word.correct { color: var(--success); }
        .word.incorrect { background: var(--error); color: white; }

        .input-bar { display: flex; gap: 15px; align-items: center; background: #f1f3f5; padding: 20px; border-radius: 8px; }
        #typing-input { flex: 1; padding: 15px; font-size: 20px; border: 1px solid #ced4da; border-radius: 6px; outline: none; }
        #timer-box { background: var(--primary); color: white; padding: 10px 20px; font-weight: bold; font-size: 24px; border-radius: 6px; min-width: 80px; text-align: center; }

        /* Tables & Helpers */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; font-size: 14px; }
        .btn { padding: 10px 18px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: var(--primary); color: white; }
        .search-box { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .star-rating { color: #f1c40f; font-size: 12px; }

        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:9999; }
        .modal-box { background:white; padding:30px; border-radius:10px; width:500px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="sidebar">
            <div id="admin-stats" class="menu-card hidden" style="background:#2c3e50; color:white; padding:15px; text-align:center">
                <small>ONLINE</small>
                <div id="online-count" style="font-size:24px; color:var(--admin-gold); font-weight:bold">1</div>
            </div>

            <div class="menu-card">
                <div class="menu-item active" id="m-1" onclick="switchTab('tab-1')"><i class="fa-solid fa-keyboard"></i> <span class="n-1">Mục 1: Tập gõ</span></div>
                <div class="menu-item" id="m-2" onclick="switchTab('tab-2')"><i class="fa-solid fa-info-circle"></i> <span class="n-2">Mục 2: Hướng dẫn</span></div>
                <div class="menu-item" id="m-3" onclick="switchTab('tab-3')"><i class="fa-solid fa-trophy"></i> <span class="n-3">Mục 3: Xếp hạng tổng</span></div>
                <div class="menu-item" id="m-4" onclick="switchTab('tab-4')"><i class="fa-solid fa-users"></i> <span class="n-4">Mục 4: Cộng đồng</span></div>
                <div class="menu-item" id="m-5" onclick="switchTab('tab-5')"><i class="fa-solid fa-cog"></i> <span class="n-5">Mục 5: Tùy chỉnh</span></div>
            </div>

            <div id="admin-gate" class="menu-card hidden">
                <div class="menu-item" onclick="switchTab('tab-admin')" style="background:#fff3cd; color:#856404; font-weight:bold"><i class="fa-solid fa-crown"></i> ADMIN PANEL</div>
            </div>

            <div class="menu-card">
                <div id="u-card" class="menu-item" style="flex-direction:column; align-items:flex-start; height:auto">
                    <div style="display:flex; width:100%; align-items:center">
                        <b id="u-name">Khách</b> <span id="u-badge"></span>
                    </div>
                    <small id="u-email" style="color:#888"></small>
                </div>
                <div class="menu-item" onclick="switchTab('tab-profile')"><i class="fa-solid fa-user"></i> Hồ sơ</div>
                <div class="menu-item" style="color:var(--error)" onclick="logout()"><i class="fa-solid fa-sign-out-alt"></i> Đăng xuất</div>
            </div>
        </div>

        <div class="content">
            <div id="tab-1" class="tab-content">
                <h2 id="typing-title">Tập gõ văn bản</h2>
                <div class="word-wrapper"><div id="word-display"></div></div>
                <div class="input-bar">
                    <input type="text" id="typing-input" placeholder="Bắt đầu gõ..." autofocus autocomplete="off">
                    <div id="timer-box">00:00</div>
                    <button class="btn" onclick="resetGame()"><i class="fa-solid fa-sync"></i></button>
                </div>
                <p id="mode-desc" style="font-size:12px; color:#666; margin-top:10px">Chế độ: Đếm ngược (Mặc định)</p>
            </div>

            <div id="tab-3" class="tab-content hidden">
                <h2>Bảng xếp hạng toàn cầu</h2>
                <table>
                    <thead><tr><th>Hạng</th><th>Người chơi</th><th>WPM Cao nhất</th><th>Ngày</th></tr></thead>
                    <tbody id="lb-body"></tbody>
                </table>
            </div>

            <div id="tab-4" class="tab-content hidden">
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <h2>Cộng đồng chia sẻ</h2>
                    <button class="btn" style="background:var(--success)" onclick="openModal('modal-create')">+ Đăng bài</button>
                </div>
                <input type="text" class="search-box" id="search-input" placeholder="Tìm kiếm tiêu đề hoặc người tạo..." oninput="renderCommunity()">
                <table>
                    <thead><tr><th>Đánh giá</th><th>Tiêu đề</th><th>Tác giả</th><th>Độ dài</th><th>Hành động</th></tr></thead>
                    <tbody id="comm-body"></tbody>
                </table>
            </div>

            <div id="tab-5" class="tab-content hidden">
                <h2>Tùy chỉnh văn bản</h2>
                <textarea id="custom-text" rows="8" style="width:100%; padding:10px" placeholder="Dán văn bản vào đây..."></textarea>
                <button class="btn" style="width:100%; margin-top:10px" onclick="startCustom()">Bắt đầu gõ</button>
            </div>

            <div id="tab-profile" class="tab-content hidden">
                <h2>Hồ sơ cá nhân</h2>
                <div id="profile-data" style="background:#f9f9f9; padding:20px; border-radius:10px"></div>
            </div>

            <div id="tab-admin" class="tab-content hidden">
                <h2>Quản lý God Mode</h2>
                <h3>Danh sách tài khoản & Mật khẩu</h3>
                <table><thead><tr><th>User</th><th>Email</th><th>Password</th></tr></thead><tbody id="admin-users"></tbody></table>
            </div>
        </div>
    </div>

    <div id="modal-auth" class="modal">
        <div class="modal-box">
            <h2>Đăng nhập / Đăng ký</h2>
            <input type="text" id="au" placeholder="Tên hoặc Email (nhtseri52@gmail.com)">
            <input type="password" id="ap" placeholder="Mật khẩu (Locthinh52!)">
            <button class="btn" style="width:100%" onclick="handleAuth()">Xác nhận</button>
        </div>
    </div>

    <div id="modal-create" class="modal">
        <div class="modal-box">
            <h3>Chia sẻ văn bản</h3>
            <input type="text" id="post-t" placeholder="Tiêu đề">
            <textarea id="post-c" rows="5" style="width:100%" placeholder="Nội dung văn bản"></textarea>
            <button class="btn" style="width:100%" onclick="savePost()">Đăng bài</button>
            <button class="btn" style="width:100%; background:#999; margin-top:5px" onclick="closeModal('modal-create')">Hủy</button>
        </div>
    </div>

    <script>
        const ADMIN = { u: "nhtseri", e: "nhtseri52@gmail.com", p: "Locthinh52!" };
        let user = JSON.parse(localStorage.getItem('typing_user')) || null;
        
        let currentWords = "anh|em|lập|trình|đánh|máy|chuyên|nghiệp|nỗ|lực|thành|công".split('|');
        let timer, timePassed = 0, isCountDown = true, timeLeft = 60;
        let curIdx = 0, corrects = 0;

        // --- AUTH ---
        function handleAuth() {
            const u = document.getElementById('au').value.trim();
            const p = document.getElementById('ap').value.trim();
            if((u === ADMIN.u || u === ADMIN.e) && p === ADMIN.p) {
                user = { u: ADMIN.u, e: ADMIN.e, isAdmin: true };
            } else {
                user = { u: u, e: u+"@gmail.com", isAdmin: false };
                localStorage.setItem('acc_'+u, JSON.stringify({p:p, e:user.e}));
            }
            localStorage.setItem('typing_user', JSON.stringify(user));
            location.reload();
        }
        function logout() { localStorage.removeItem('typing_user'); location.reload(); }

        // --- TYPING ENGINE ---
        function resetGame() {
            clearInterval(timer); timer = null;
            timePassed = 0; timeLeft = 60; curIdx = 0; corrects = 0;
            document.getElementById('timer-box').innerText = isCountDown ? "01:00" : "00:00";
            document.getElementById('typing-input').value = "";
            
            let pool = isCountDown ? Array.from({length:80}, () => currentWords[Math.floor(Math.random()*currentWords.length)]) : currentWords;
            document.getElementById('word-display').innerHTML = pool.map((w,i)=>`<span class="word" id="w-${i}">${w}</span>`).join('');
            document.getElementById('w-0').classList.add('current');
            document.getElementById('word-display').style.transform = "translateY(0)";
        }

        document.getElementById('typing-input').addEventListener('input', function() {
            if(!timer) {
                timer = setInterval(() => {
                    if(isCountDown) {
                        timeLeft--;
                        let m = Math.floor(timeLeft/60), s = timeLeft%60;
                        document.getElementById('timer-box').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                        if(timeLeft <= 0) finish();
                    } else {
                        timePassed++;
                        let m = Math.floor(timePassed/60), s = timePassed%60;
                        document.getElementById('timer-box').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                    }
                }, 1000);
            }

            if(this.value.endsWith(' ')) {
                const typed = this.value.trim();
                const el = document.getElementById(`w-${curIdx}`);
                if(!el) return;
                
                if(typed === el.innerText) { el.classList.add('correct'); corrects++; }
                else el.classList.add('incorrect');
                
                el.classList.remove('current');
                curIdx++;
                
                if(curIdx >= document.querySelectorAll('.word').length && !isCountDown) {
                    finish(); return;
                }

                const next = document.getElementById(`w-${curIdx}`);
                if(next) {
                    next.classList.add('current');
                    if(next.offsetTop > 45) document.getElementById('word-display').style.transform = `translateY(-${next.offsetTop-10}px)`;
                }
                this.value = "";
            }
        });

        function finish() {
            clearInterval(timer);
            const duration = isCountDown ? 60 : timePassed;
            const wpm = Math.round((corrects / duration) * 60);
            alert(`Hoàn thành! Tốc độ: ${wpm} WPM`);
            saveScore(wpm);
            isCountDown = true; // Reset về mặc định
            resetGame();
        }

        function saveScore(wpm) {
            let scores = JSON.parse(localStorage.getItem('global_lb') || "[]");
            let idx = scores.findIndex(s => s.u === user.u);
            if(idx === -1) scores.push({u: user.u, wpm: wpm, d: new Date().toLocaleDateString()});
            else if(wpm > scores[idx].wpm) scores[idx] = {u: user.u, wpm: wpm, d: new Date().toLocaleDateString()};
            scores.sort((a,b) => b.wpm - a.wpm);
            localStorage.setItem('global_lb', JSON.stringify(scores));
        }

        // --- CỘNG ĐỒNG ---
        function savePost() {
            const t = document.getElementById('post-t').value, c = document.getElementById('post-c').value;
            if(!t || !c) return;
            let posts = JSON.parse(localStorage.getItem('posts') || "[]");
            posts.push({t, c, author: user.u, rating: (Math.random()*2 + 3).toFixed(1), views: 0});
            localStorage.setItem('posts', JSON.stringify(posts));
            renderCommunity(); closeModal('modal-create');
        }

        function renderCommunity() {
            let posts = JSON.parse(localStorage.getItem('posts') || "[]");
            let search = document.getElementById('search-input').value.toLowerCase();
            let filtered = posts.filter(p => p.t.toLowerCase().includes(search) || p.author.toLowerCase().includes(search));
            
            document.getElementById('comm-body').innerHTML = filtered.map((p,i) => `
                <tr>
                    <td><span class="star-rating">★ ${p.rating}</span></td>
                    <td><b>${p.t}</b></td>
                    <td>${p.author}</td>
                    <td>${p.c.split(' ').length} từ</td>
                    <td><button class="btn" onclick="goPost(${i})">Gõ bài này</button></td>
                </tr>
            `).join('');
        }

        function goPost(i) {
            let posts = JSON.parse(localStorage.getItem('posts') || "[]");
            currentWords = posts[i].c.split(/\s+/);
            isCountDown = false;
            document.getElementById('typing-title').innerText = "Đang gõ: " + posts[i].t;
            document.getElementById('mode-desc').innerText = "Chế độ: Gõ hết văn bản (Tác giả: " + posts[i].author + ")";
            switchTab('tab-1');
            resetGame();
        }

        // --- TABS & ADMIN ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'tab-3') renderLB();
            if(id === 'tab-4') renderCommunity();
            if(id === 'tab-admin') renderAdmin();
            if(id === 'tab-profile') renderProfile();
        }

        function renderLB() {
            let scores = JSON.parse(localStorage.getItem('global_lb') || "[]");
            document.getElementById('lb-body').innerHTML = scores.map((s,i) => `<tr><td>${i+1}</td><td>${s.u}</td><td>${s.wpm}</td><td>${s.d}</td></tr>`).join('');
        }

        function renderAdmin() {
            let html = '';
            for(let i=0; i<localStorage.length; i++){
                let k = localStorage.key(i);
                if(k.startsWith('acc_')) {
                    let d = JSON.parse(localStorage.getItem(k));
                    html += `<tr><td>${k.replace('acc_','')}</td><td>${d.e}</td><td>${d.p}</td></tr>`;
                }
            }
            document.getElementById('admin-users').innerHTML = html;
        }

        function renderProfile() {
            document.getElementById('profile-data').innerHTML = `<p>Tên: ${user.u}</p><p>Email: ${user.e}</p><button class="btn" style="background:var(--error)" onclick="logout()">Đăng xuất</button>`;
        }

        function startCustom() {
            const txt = document.getElementById('custom-text').value.trim();
            if(!txt) return;
            currentWords = txt.split(/\s+/);
            isCountDown = false;
            switchTab('tab-1');
            resetGame();
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        window.onload = () => {
            if(!user) openModal('modal-auth');
            else {
                document.getElementById('u-name').innerText = user.u;
                document.getElementById('u-email').innerText = user.e;
                if(user.isAdmin || user.e === ADMIN.e) {
                    document.getElementById('admin-gate').classList.remove('hidden');
                    document.getElementById('admin-stats').classList.remove('hidden');
                    document.getElementById('u-badge').innerHTML = '<span class="admin-badge">GOD MODE</span>';
                    document.getElementById('u-card').classList.add('admin-frame');
                }
                resetGame(); renderCommunity();
            }
        };
    </script>
</body>
</html>
