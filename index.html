<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Typing CMS Ultimate - Admin Power</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2980b9; --bg: #f0f2f5; --gold: #f1c40f; --dark: #2c3e50; --success: #27ae60; --danger: #e74c3c; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); display: flex; padding: 20px; gap: 20px; margin: 0; height: 100vh; }
        
        .sidebar { width: 300px; flex-shrink: 0; display: flex; flex-direction: column; gap: 15px; }
        .main-content { flex-grow: 1; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow-y: auto; }
        .card { background: white; border-radius: 12px; border: 1px solid #ddd; overflow: hidden; }
        
        .nav-item { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; border-bottom: 1px solid #eee; }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-item:hover:not(.active) { background: #f8f8f8; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 450px; text-align: center; }

        .word-display { font-size: 24px; padding: 20px; background: #fafafa; border: 2px solid #eee; border-radius: 10px; min-height: 120px; margin-bottom: 20px; line-height: 1.6; }
        .word-active { background: #dcdde1; border-bottom: 3px solid var(--primary); }
        .word-correct { color: var(--success); }
        .word-wrong { color: var(--danger); text-decoration: underline; }
        
        .typing-box { display: flex; gap: 10px; background: #adcce9; padding: 15px; border-radius: 10px; }
        .input-style { flex: 1; padding: 12px; font-size: 18px; border: none; border-radius: 5px; outline: none; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        
        .admin-section { background: #fff3cd; padding: 15px; border-radius: 10px; border: 1px solid #ffeeba; margin-top: 20px; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
    </style>
</head>
<body>

    <div id="auth-screen" class="modal" style="display: flex;">
        <div class="modal-content">
            <h2>Hệ thống Đánh máy</h2>
            <input type="text" id="auth-u" placeholder="Tên đăng nhập" style="width:100%; padding:12px; margin:10px 0;">
            <input type="password" id="auth-p" placeholder="Mật khẩu" style="width:100%; padding:12px; margin:10px 0;">
            <button class="btn btn-primary" style="width:100%" onclick="app.handleAuth()">ĐĂNG NHẬP / ĐĂNG KÝ</button>
            <p style="font-size:12px; color:#666; margin-top:10px;">Admin: nhtseri | Pass: Locthinh1!</p>
        </div>
    </div>

    <div id="result-modal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--gold)"><i class="fa-solid fa-trophy"></i> Kết quả</h2>
            <div style="display:flex; justify-content:space-around; margin:20px 0;">
                <div><h1 id="res-wpm">0</h1><small>WPM</small></div>
                <div><h1 id="res-acc">0%</h1><small>Chính xác</small></div>
            </div>
            <button class="btn btn-primary" onclick="app.closeResult()">TIẾP TỤC</button>
        </div>
    </div>

    <div class="sidebar" id="sidebar-inject"></div>

    <div class="main-content">
        <div id="page-1" class="page">
            <h2 id="title-m1">Mục 1: Tập gõ</h2>
            <div id="word-display-1" class="word-display"></div>
            <div class="typing-box">
                <input type="text" id="input-1" class="input-style" placeholder="Bắt đầu gõ..." autocomplete="off">
                <div id="timer-1" style="background:var(--dark); color:white; padding:10px; border-radius:5px; font-weight:bold;">60</div>
            </div>
        </div>

        <div id="page-2" class="page">
            <h2 id="title-m2">Mục 2: Hướng dẫn</h2>
            <div id="content-m2">
                <img id="img-m2" src="https://vcdn-vnexpress.vnecdn.net/2021/03/17/keyboard-1615969566-8835-1615969623.jpg" style="max-width:100%; border-radius:10px;">
                <p>Đặt tay đúng vị trí phím F và J để đạt tốc độ cao nhất.</p>
            </div>
        </div>

        <div id="page-3" class="page">
            <h2 id="title-m3">Mục 3: Xếp hạng</h2>
            <table><thead><tr><th>Hạng</th><th>Tên</th><th>WPM</th><th>Độ chính xác</th></tr></thead><tbody id="rank-list"></tbody></table>
        </div>

        <div id="page-4" class="page">
            <h2 id="title-m4">Mục 4: Cộng đồng</h2>
            <div style="margin-bottom:15px; display:flex; gap:10px;">
                <input type="text" id="search-comm" placeholder="Tìm tên bài..." oninput="app.renderComm()" style="padding:8px; flex:1; border-radius:5px; border:1px solid #ddd;">
                <button class="btn btn-primary" onclick="app.sortComm('new')">Mới nhất</button>
                <button class="btn btn-primary" onclick="app.sortComm('like')">Top Like</button>
                <button class="btn btn-success" onclick="app.addPost()">+ Đăng bài</button>
            </div>
            <div id="comm-list-container">
                <table><thead><tr><th>Bài viết</th><th>Người đăng</th><th>Like</th><th>Thao tác</th></tr></thead><tbody id="comm-list"></tbody></table>
            </div>
        </div>

        <div id="page-admin" class="page">
            <h2 style="color:var(--danger)"><i class="fa-solid fa-shield-halved"></i> QUẢN TRỊ VIÊN (GOD MODE)</h2>
            
            <div class="admin-section">
                <h3>1. Quản lý Mục (Đổi tên & Nội dung)</h3>
                <select id="select-page" onchange="app.loadPageConfig()">
                    <option value="1">Mục 1</option><option value="2">Mục 2</option>
                    <option value="3">Mục 3</option><option value="4">Mục 4</option>
                </select>
                <input type="text" id="conf-title" placeholder="Đổi tên mục" style="padding:5px;">
                <input type="text" id="conf-img" placeholder="Link ảnh (nếu có)" style="padding:5px;">
                <button class="btn btn-primary" onclick="app.savePageConfig()">Cập nhật</button>
            </div>

            <div class="admin-section">
                <h3>2. Quản lý Tài khoản người dùng</h3>
                <table><thead><tr><th>User</th><th>Pass</th><th>Gmail</th><th>Thao tác</th></tr></thead><tbody id="admin-user-list"></tbody></table>
            </div>
            
            <div class="admin-section">
                <h3>3. Cơ chế Mục 1 (Thời gian gõ)</h3>
                Giây: <input type="number" id="conf-time" value="60" style="width:60px;">
                <button class="btn btn-primary" onclick="app.saveMechanic()">Lưu cơ chế</button>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_WORDS = "hành|trình|vạn|dặm|bắt|đầu|từ|một|bước|chân|đam|mê|chiến|thắng|thành|công".split('|');
        
        const app = {
            user: null, words: [], curIdx: 0, timer: null, timeLeft: 60, ok: 0, err: 0, isPlaying: false,
            config: JSON.parse(localStorage.getItem('sys_config')) || { m1: "Mục 1: Tập gõ", m2: "Mục 2: Hướng dẫn", m3: "Mục 3: Xếp hạng", m4: "Mục 4: Cộng đồng", time: 60, img2: "" },

            init() {
                const session = localStorage.getItem('current_session');
                if(session) {
                    this.user = JSON.parse(session);
                    document.getElementById('auth-screen').style.display = 'none';
                    this.applyConfig();
                    this.showPage(1);
                }
            },

            handleAuth() {
                const u = document.getElementById('auth-u').value.trim(), p = document.getElementById('auth-p').value.trim();
                if(u === 'nhtseri' && p === 'Locthinh1!') {
                    this.user = { u, isAdmin: true, e: 'admin@system.com' };
                } else {
                    let data = JSON.parse(localStorage.getItem('user_' + u));
                    if(data) {
                        if(data.p === p) this.user = { u, isAdmin: false, e: data.e };
                        else return alert("Sai mật khẩu!");
                    } else {
                        localStorage.setItem('user_' + u, JSON.stringify({p, e: u+'@gmail.com'}));
                        this.user = { u, isAdmin: false, e: u+'@gmail.com' };
                    }
                }
                localStorage.setItem('current_session', JSON.stringify(this.user));
                location.reload();
            },

            applyConfig() {
                document.getElementById('title-m1').innerText = this.config.m1;
                document.getElementById('title-m2').innerText = this.config.m2;
                document.getElementById('title-m3').innerText = this.config.m3;
                document.getElementById('title-m4').innerText = this.config.m4;
                if(this.config.img2) document.getElementById('img-m2').src = this.config.img2;
                this.timeLeft = this.config.time;
                this.renderSidebar();
            },

            renderSidebar() {
                const menu = [
                    {id: 1, name: this.config.m1, icon: 'keyboard'},
                    {id: 2, name: this.config.m2, icon: 'book'},
                    {id: 3, name: this.config.m3, icon: 'trophy'},
                    {id: 4, name: this.config.m4, icon: 'users'}
                ];
                let h = `<div class="card"><div style="padding:20px; text-align:center;"><b>Chào, ${this.user.u}</b></div>`;
                menu.forEach(m => h += `<div class="nav-item" id="nav-${m.id}" onclick="app.showPage(${m.id})"><i class="fa-solid fa-${m.icon}" style="width:25px"></i> ${m.name}</div>`);
                if(this.user.isAdmin) h += `<div class="nav-item" id="nav-admin" style="color:var(--danger)" onclick="app.showPage('admin')"><i class="fa-solid fa-gears" style="width:25px"></i> GOD MODE</div>`;
                h += `<div class="nav-item" style="color:#999" onclick="app.logout()">Đăng xuất</div></div>`;
                document.getElementById('sidebar-inject').innerHTML = h;
            },

            showPage(id) {
                document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.getElementById('page-'+id).style.display = 'block';
                document.getElementById('nav-'+id).classList.add('active');
                if(id === 1) this.resetTyping();
                if(id === 4) this.renderComm();
                if(id === 'admin') this.renderAdminTools();
            },

            resetTyping() {
                clearInterval(this.timer);
                this.timeLeft = this.config.time;
                this.curIdx = 0; this.ok = 0; this.err = 0; this.isPlaying = false;
                document.getElementById('timer-1').innerText = this.timeLeft;
                document.getElementById('input-1').value = "";
                document.getElementById('input-1').disabled = false;
                this.words = Array.from({length:30}, () => DEFAULT_WORDS[Math.floor(Math.random()*DEFAULT_WORDS.length)]);
                this.renderWords();
            },

            renderWords() {
                document.getElementById('word-display-1').innerHTML = this.words.map((w,i) => `<span id="w-${i}" class="${i===0?'word-active':''}">${w}</span>`).join(" ");
            },

            handleTyping(e) {
                if(!this.isPlaying) { this.isPlaying = true; this.startTimer(); }
                if(e.target.value.endsWith(" ")) {
                    const typed = e.target.value.trim();
                    const el = document.getElementById('w-'+this.curIdx);
                    if(typed === this.words[this.curIdx]) { el.className = 'word-correct'; this.ok++; }
                    else { el.className = 'word-wrong'; this.err++; }
                    this.curIdx++;
                    if(this.curIdx < this.words.length) document.getElementById('w-'+this.curIdx).className = 'word-active';
                    else this.finish();
                    e.target.value = "";
                }
            },

            startTimer() {
                this.timer = setInterval(() => {
                    this.timeLeft--;
                    document.getElementById('timer-1').innerText = this.timeLeft;
                    if(this.timeLeft <= 0) this.finish();
                }, 1000);
            },

            finish() {
                clearInterval(this.timer);
                const acc = Math.round((this.ok / (this.ok + this.err)) * 100) || 0;
                document.getElementById('res-wpm').innerText = this.ok;
                document.getElementById('res-acc').innerText = acc + "%";
                document.getElementById('result-modal').style.display = 'flex';
                document.getElementById('input-1').disabled = true;
            },

            closeResult() { document.getElementById('result-modal').style.display = 'none'; this.resetTyping(); },

            // --- Mục 4 Logic ---
            renderComm() {
                let posts = JSON.parse(localStorage.getItem('posts_v2') || "[]");
                const search = document.getElementById('search-comm').value.toLowerCase();
                if(search) posts = posts.filter(p => p.t.toLowerCase().includes(search));
                
                document.getElementById('comm-list').innerHTML = posts.map((p, idx) => `
                    <tr>
                        <td><b>${p.t}</b></td><td>${p.u}</td><td>❤️ ${p.likes || 0}</td>
                        <td>
                            <button class="btn btn-primary" onclick="app.likePost(${idx})">Like</button>
                            ${(this.user.isAdmin || p.u === this.user.u) ? `<button class="btn btn-danger" onclick="app.deletePost(${idx})">Xoá</button>` : ''}
                        </td>
                    </tr>
                `).join("");
            },

            addPost() {
                const t = prompt("Tiêu đề bài gõ:"), c = prompt("Nội dung:");
                if(!t || !c) return;
                let posts = JSON.parse(localStorage.getItem('posts_v2') || "[]");
                posts.unshift({ t, c, u: this.user.u, likes: 0, date: Date.now() });
                localStorage.setItem('posts_v2', JSON.stringify(posts));
                this.renderComm();
            },

            likePost(idx) {
                let posts = JSON.parse(localStorage.getItem('posts_v2'));
                posts[idx].likes = (posts[idx].likes || 0) + 1;
                localStorage.setItem('posts_v2', JSON.stringify(posts));
                this.renderComm();
            },

            deletePost(idx) {
                if(!confirm("Xoá bài này?")) return;
                let posts = JSON.parse(localStorage.getItem('posts_v2'));
                posts.splice(idx, 1);
                localStorage.setItem('posts_v2', JSON.stringify(posts));
                this.renderComm();
            },

            sortComm(type) {
                let posts = JSON.parse(localStorage.getItem('posts_v2') || "[]");
                if(type === 'like') posts.sort((a,b) => b.likes - a.likes);
                else posts.sort((a,b) => b.date - a.date);
                localStorage.setItem('posts_v2', JSON.stringify(posts));
                this.renderComm();
            },

            // --- Admin Tools ---
            renderAdminTools() {
                let userH = '';
                for(let i=0; i<localStorage.length; i++){
                    let k = localStorage.key(i);
                    if(k.startsWith('user_')){
                        let d = JSON.parse(localStorage.getItem(k));
                        userH += `<tr><td>${k.replace('user_','')}</td><td>${d.p}</td><td>${d.e}</td><td><button onclick="app.delUser('${k}')">Xoá</button></td></tr>`;
                    }
                }
                document.getElementById('admin-user-list').innerHTML = userH;
            },

            savePageConfig() {
                const p = document.getElementById('select-page').value;
                const title = document.getElementById('conf-title').value;
                const img = document.getElementById('conf-img').value;
                if(title) this.config['m'+p] = title;
                if(p == '2' && img) this.config.img2 = img;
                localStorage.setItem('sys_config', JSON.stringify(this.config));
                alert("Đã cập nhật hệ thống!"); location.reload();
            },

            saveMechanic() {
                this.config.time = document.getElementById('conf-time').value;
                localStorage.setItem('sys_config', JSON.stringify(this.config));
                alert("Đã đổi thời gian gõ!");
            },

            delUser(k) { if(confirm("Xoá người dùng này?")) { localStorage.removeItem(k); this.renderAdminTools(); } },

            logout() { localStorage.removeItem('current_session'); location.reload(); }
        };

        document.getElementById('input-1').addEventListener('input', (e) => app.handleTyping(e));
        window.onload = () => app.init();
    </script>
</body>
</html>
